<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Report</title>
    <style>
        *, *:before, *:after {
            box-sizing: border-box;
        }
        main > * {
            margin-bottom: 12px;
        }
        main *:last-child {
            margin-bottom: 0;
        }
        .covid19-location-info {
            display: flex;
            flex-direction: column;
            border: 1px solid black;
            padding: 12px;
        }
        .covid19-location-info .covid19-location-info-coords {
            display: flex;
            justify-content: space-evenly;
            margin-bottom: 6px;
        }
        .covid19-data {
            overflow-x: auto;
        }
        .covid19-data table {
            text-align: left;
            border-spacing: 6px;
        }
        .covid19-data table tr:nth-child(even) {
            background-color: white;
        }
        .covid19-data table tr:nth-child(odd) {
            background-color: whitesmoke;
        }
        .covid19-data table th, .covid19-data table td {
            padding: 6px;
        }
        footer {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <header>
        <h1>COVID-19 Report</h1>
    </header>
    <main>
        <div class="covid19-location-info">
            <div class="covid19-location-info-coords">
                <span>Your Lat: <span id="location-lat">N/A</span></span>
                <span>Your Long: <span id="location-long">N/A</span></span>
            </div>
            <button disabled id="location-button">Sort by nearest me</button>
        </div>
        <div class="covid19-data">Loading...</div>
    </main>
    <footer>
        <h2>Resources</h2>
        <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE</a>
        <a href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6" target="_blank">Coronavirus COVID-19 Global Cases by Johns Hopkins CSSE (Desktop Visual Dashboard)</a>
        <a href="https://www.arcgis.com/apps/opsdashboard/index.html#/85320e2ea5424dfaaa75ae62e5c06e61" target="_blank">Coronavirus COVID-19 Global Cases by Johns Hopkins CSSE (Mobile Visual Dashboard)</a>
    </footer>
    <script>
        let tableData;

        const h1Elem = document.querySelector('h1');
        const titleElem = document.querySelector('title');
        const currentDateString = (new Date()).toDateString();
        h1Elem.textContent = `${h1Elem.textContent} - ${currentDateString}`;
        titleElem.textContent = `${titleElem.textContent} - ${currentDateString}`;

        const covid19DataElem = document.querySelector('.covid19-data');

        const lat = document.getElementById('location-lat');
        const long = document.getElementById('location-long');

        const locationButton = document.getElementById('location-button');

        if (navigator.geolocation) {
            locationButton.addEventListener('click', () => {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude } = pos.coords;

                    lat.textContent = latitude;
                    long.textContent = longitude;

                    renderTable(sortTableDataByLocation(tableData, latitude, longitude));
                }, (err) => {
                    console.error(err);

                    lat.textContent = 'Error';
                    long.textContent = 'Error';
                });
            });
        }

        function renderTable(tableData) {
            const table = document.createElement('table');

            const tableHeaderRow = document.createElement('tr');
            tableData[0]
                .forEach(tableHeader => {
                    const tableHeaderCell = document.createElement('th');
                    tableHeaderCell.textContent = tableHeader;
                    tableHeaderRow.appendChild(tableHeaderCell);
                });
            table.appendChild(tableHeaderRow);

            tableData
                .slice(1)
                .forEach(tableRow => {
                    const tableDataRow = document.createElement('tr');
                    tableRow.forEach(tableCell => {
                        const tableDataCell = document.createElement('td');
                        tableDataCell.textContent = tableCell;
                        tableDataRow.appendChild(tableDataCell);
                    });
                    table.appendChild(tableDataRow);
                });

            covid19DataElem.innerHTML = '';
            covid19DataElem.appendChild(table);
        }

        function sortTableDataByLocation(tableData, lat, long) {
            tableData
                .slice(1)
                .forEach(tableRow => {
                    const [rowLat, rowLong] = [
                        parseFloat(tableRow[5], 10),
                        parseFloat(tableRow[6], 10)
                    ];
                    const distance = getDistanceFromLatLonInMiles(rowLat, rowLong, lat, long);

                    if (typeof tableRow[7] === 'number') {
                        tableRow[7] = distance;
                    } else {
                        tableRow.push(distance);
                    }
                });

            const sortedTableData = tableData
                .slice(1)
                .sort((row1, row2) => {
                    return row1[7] - row2[7];
                });
            
            // add back header row, with additional 'Distance in miles' table header
            if (typeof tableData[7] !== 'string') {
                sortedTableData.unshift([...tableData[0], 'Distance in miles']);
            }

            return sortedTableData;
        }

        // https://stackoverflow.com/a/27943 - Haversine formula
        const R = 6371 * 0.6213712; // Radius of the earth in miles
        const radianDegreeRatio = Math.PI / 180;
        function getDistanceFromLatLonInMiles(lat1, lon1, lat2, lon2) {
            const dLat = (lat2 - lat1) * radianDegreeRatio;
            const dLon = (lon2 - lon1) * radianDegreeRatio; 
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * radianDegreeRatio) * Math.cos(lat2 * radianDegreeRatio) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            const d = R * c; // Distance in miles
            return d;
        }

        fetch('/api/latest-report')
            .then(response => response.json())
            .then(latestReport => {
                tableData = latestReport;
                locationButton.disabled = false;
                renderTable(latestReport);
            })
            .catch(err => {
                console.error(err);
                covid19DataElem.textContent = 'An error occurred, please refresh.';
            });
    </script>
</body>
</html>